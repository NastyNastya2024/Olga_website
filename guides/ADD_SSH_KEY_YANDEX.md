# Как добавить SSH-ключ в Yandex Cloud

## Пошаговая инструкция

### Шаг 1: Создайте SSH-ключ на вашем Mac

```bash
cd /Users/a1/Documents/GitHub/Olga_website
./scripts/setup-ssh-key.sh
```

Или вручную:

```bash
ssh-keygen -t rsa -b 4096 -f ~/.ssh/yandex_cloud -N ""
cat ~/.ssh/yandex_cloud.pub
```

Скопируйте весь вывод (начинается с `ssh-rsa ...`).

### Шаг 2: Добавьте ключ в метаданные ВМ

**Способ 1: Через CLI Yandex Cloud (РЕКОМЕНДУЕТСЯ)**

Если нет кнопки "Изменить" в интерфейсе, используйте CLI:

1. **Установите Yandex Cloud CLI** (если еще не установлен):
   ```bash
   curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
   exec -l $SHELL
   yc version
   ```

2. **Инициализируйте CLI**:
   ```bash
   yc init
   ```
   Введите ваш токен доступа Yandex Cloud (можно получить в консоли)

3. **Добавьте SSH-ключ через CLI**:
   ```bash
   # Сначала получите публичный ключ
   cat ~/.ssh/yandex_cloud.pub
   
   # Добавьте ключ в метаданные ВМ
   yc compute instance add-metadata compute-vm-2-4-20-ssd-1769470006848 \
     --metadata-from-file ssh-keys=<(echo -e "admin:$(cat ~/.ssh/yandex_cloud.pub)")
   ```

**Способ 2: Через веб-консоль (если есть кнопка "Добавить")**

1. **Откройте Yandex Cloud Console**: https://console.cloud.yandex.ru

2. **Перейдите к вашей ВМ**:
   - Compute Cloud → Виртуальные машины
   - Выберите: `compute-vm-2-4-20-ssd-1769470006848`

3. **Попробуйте найти один из вариантов**:
   
   **Вариант A: Вкладка "SSH-ключи"**
   - Найдите вкладку **"SSH-ключи"** или **"Доступ"**
   - Там должна быть кнопка **"Добавить SSH-ключ"** или **"Добавить"**
   - Вставьте ваш публичный ключ

   **Вариант B: Через "Редактировать" ВМ**
   - Нажмите кнопку **"Редактировать"** или **"Edit"** в правом верхнем углу страницы ВМ
   - Найдите раздел **"Метаданные"** или **"Metadata"**
   - Найдите поле **`ssh-keys`**
   - Добавьте новую строку с вашим ключом

   **Вариант C: Через "Создать ВМ" (копирование конфигурации)**
   - Нажмите **"Создать ВМ"** → **"Создать из образа"**
   - Выберите вашу текущую ВМ как шаблон
   - В разделе метаданных добавьте SSH-ключ
   - **НЕ создавайте новую ВМ**, просто посмотрите, где там добавляются ключи

**Способ 3: Через API (для продвинутых пользователей)**

Если у вас есть токен доступа:

```bash
# Получите токен в консоли: https://console.cloud.yandex.ru/iam/service-accounts
# Или используйте OAuth токен

# Получите текущие метаданные
yc compute instance get compute-vm-2-4-20-ssd-1769470006848 --format json | jq '.metadata."ssh-keys"'

# Добавьте новый ключ
NEW_KEY="admin:$(cat ~/.ssh/yandex_cloud.pub)"
yc compute instance update-metadata compute-vm-2-4-20-ssd-1769470006848 \
  --metadata-from-file ssh-keys=<(echo -e "$(yc compute instance get compute-vm-2-4-20-ssd-1769470006848 --format json | jq -r '.metadata."ssh-keys"')"$'\n'"$NEW_KEY")
```

### Формат ключа

Ключ должен быть в формате:
```
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQ... ваш_ключ your_email@example.com
```

Или для добавления в метаданные `ssh-keys`:
```
admin:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQ... ваш_ключ
```

### Шаг 3: Подключитесь к серверу

После добавления ключа подождите 1-2 минуты и подключитесь:

```bash
ssh -i ~/.ssh/yandex_cloud admin@158.160.192.242
```

Если всё настроено правильно, вы должны подключиться без запроса пароля.

---

## Визуальное руководство

### Где искать метаданные:

1. Откройте вашу ВМ в консоли
2. Прокрутите вниз до секции **"Метаданные"** или **"Metadata"**
3. Раскройте секцию (нажмите на стрелку ▼)
4. Найдите `ssh-keys` — там список всех SSH-ключей

### Как выглядит секция ssh-keys:

```
ssh-keys:
  admin:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQ... (существующий ключ)
```

После добавления вашего ключа будет:

```
ssh-keys:
  admin:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQ... (существующий ключ)
  admin:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQ... (ваш новый ключ)
```

---

## Проверка

После добавления ключа проверьте подключение:

```bash
# Подключение с указанием ключа
ssh -i ~/.ssh/yandex_cloud admin@158.160.192.242

# Или с подробным выводом для отладки
ssh -v -i ~/.ssh/yandex_cloud admin@158.160.192.242
```

Если видите ошибку, проверьте:
- Правильность формата ключа
- Что ключ добавлен в метаданные `ssh-keys`
- Что прошло 1-2 минуты после добавления (для применения изменений)

---

## Решение проблем

### Ошибка: "Permission denied (publickey)"

1. Проверьте, что ключ добавлен в метаданные `ssh-keys`
2. Убедитесь, что используете правильный приватный ключ:
   ```bash
   ssh -i ~/.ssh/yandex_cloud admin@158.160.192.242
   ```
3. Проверьте права на файл ключа:
   ```bash
   chmod 600 ~/.ssh/yandex_cloud
   ```

### Ключ не работает сразу после добавления

Подождите 1-2 минуты — изменения в метаданных применяются не мгновенно.

### Не могу найти секцию "Метаданные"

Попробуйте найти вкладку **"SSH-ключи"** или **"Доступ"** в интерфейсе ВМ.
