#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è SSH-–∫–ª—é—á–∞ –≤ Yandex Cloud —á–µ—Ä–µ–∑ CLI

set -e

VM_NAME="compute-vm-2-4-20-ssd-1769470006848"
KEY_PATH="$HOME/.ssh/yandex_cloud.pub"
VM_USER="admin"

echo "üîë –î–æ–±–∞–≤–ª–µ–Ω–∏–µ SSH-–∫–ª—é—á–∞ –≤ Yandex Cloud"
echo "======================================"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞
if [ ! -f "$KEY_PATH" ]; then
    echo "‚ùå –ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω: $KEY_PATH"
    echo ""
    echo "–°–æ–∑–¥–∞–π—Ç–µ –∫–ª—é—á —Å–Ω–∞—á–∞–ª–∞:"
    echo "  ./scripts/setup-ssh-key.sh"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Yandex Cloud CLI
if ! command -v yc &> /dev/null; then
    echo "‚ùå Yandex Cloud CLI –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    echo ""
    echo "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ CLI:"
    echo "  curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash"
    echo "  exec -l \$SHELL"
    echo ""
    echo "–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–µ–±-–∫–æ–Ω—Å–æ–ª—å:"
    echo "  1. –û—Ç–∫—Ä–æ–π—Ç–µ –≤–∞—à—É –í–ú –≤ –∫–æ–Ω—Å–æ–ª–∏"
    echo "  2. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å' –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É"
    echo "  3. –ù–∞–π–¥–∏—Ç–µ —Ä–∞–∑–¥–µ–ª '–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ'"
    echo "  4. –î–æ–±–∞–≤—å—Ç–µ –∫–ª—é—á –≤ –ø–æ–ª–µ ssh-keys"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ CLI
if ! yc config list &> /dev/null; then
    echo "‚ö†Ô∏è  Yandex Cloud CLI –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω"
    echo ""
    echo "–í—ã–ø–æ–ª–Ω–∏—Ç–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é:"
    echo "  yc init"
    echo ""
    echo "–í–∞–º –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è:"
    echo "  - OAuth —Ç–æ–∫–µ–Ω (–ø–æ–ª—É—á–∏—Ç–µ –≤ –∫–æ–Ω—Å–æ–ª–∏)"
    echo "  - –ò–ª–∏ —Ç–æ–∫–µ–Ω —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞"
    exit 1
fi

echo "üìã –ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á:"
cat "$KEY_PATH"
echo ""

# –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
NEW_KEY="$VM_USER:$(cat $KEY_PATH)"

echo "üîÑ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–∞ –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –í–ú..."
echo ""

# –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
CURRENT_KEYS=$(yc compute instance get "$VM_NAME" --format json 2>/dev/null | grep -o '"ssh-keys":"[^"]*"' | cut -d'"' -f4 || echo "")

if [ -z "$CURRENT_KEYS" ]; then
    # –ï—Å–ª–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–µ
    echo "–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö ssh-keys..."
    yc compute instance update-metadata "$VM_NAME" \
        --metadata-from-file ssh-keys=<(echo -e "$NEW_KEY")
else
    # –î–æ–±–∞–≤–ª—è–µ–º –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º
    echo "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–ª—é—á–∞–º..."
    UPDATED_KEYS=$(echo -e "$CURRENT_KEYS"$'\n'"$NEW_KEY")
    yc compute instance update-metadata "$VM_NAME" \
        --metadata-from-file ssh-keys=<(echo -e "$UPDATED_KEYS")
fi

if [ $? -eq 0 ]; then
    echo ""
    echo "‚úÖ SSH-–∫–ª—é—á —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!"
    echo ""
    echo "‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ 1-2 –º–∏–Ω—É—Ç—ã –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π"
    echo ""
    echo "–ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É:"
    echo "  ssh -i ~/.ssh/yandex_cloud admin@158.160.192.242"
else
    echo ""
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–ª—é—á–∞"
    echo ""
    echo "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ –≤–µ–±-–∫–æ–Ω—Å–æ–ª—å:"
    echo "  1. –û—Ç–∫—Ä–æ–π—Ç–µ –≤–∞—à—É –í–ú –≤ –∫–æ–Ω—Å–æ–ª–∏"
    echo "  2. –ù–∞–∂–º–∏—Ç–µ '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å' (–∫–Ω–æ–ø–∫–∞ –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É)"
    echo "  3. –ù–∞–π–¥–∏—Ç–µ —Ä–∞–∑–¥–µ–ª '–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ' ‚Üí 'ssh-keys'"
    echo "  4. –î–æ–±–∞–≤—å—Ç–µ —Å—Ç—Ä–æ–∫—É: $NEW_KEY"
    exit 1
fi
