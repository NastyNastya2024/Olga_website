#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è SSH-–∫–ª—é—á–∞ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Yandex Cloud

set -e

KEY_NAME="yandex_cloud"
KEY_PATH="$HOME/.ssh/$KEY_NAME"
VM_IP="158.160.192.242"
VM_USER="admin"

echo "üîë –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH-–∫–ª—é—á–∞ –¥–ª—è Yandex Cloud"
echo "========================================"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∫–ª—é—á–∞
if [ -f "$KEY_PATH" ]; then
    echo "‚ö†Ô∏è  SSH-–∫–ª—é—á —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: $KEY_PATH"
    read -p "–ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "–û—Ç–º–µ–Ω–µ–Ω–æ."
        exit 0
    fi
    rm -f "$KEY_PATH" "$KEY_PATH.pub"
fi

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ .ssh –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
mkdir -p ~/.ssh
chmod 700 ~/.ssh

# –°–æ–∑–¥–∞–Ω–∏–µ SSH-–∫–ª—é—á–∞
echo "üìù –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ SSH-–∫–ª—é—á–∞..."
ssh-keygen -t rsa -b 4096 -f "$KEY_PATH" -N "" -C "yandex-cloud-$(date +%Y%m%d)"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø—Ä–∞–≤
chmod 600 "$KEY_PATH"
chmod 644 "$KEY_PATH.pub"

echo ""
echo "‚úÖ SSH-–∫–ª—é—á —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!"
echo ""
echo "=========================================="
echo "üìã –ü–£–ë–õ–ò–ß–ù–´–ô –ö–õ–Æ–ß (—Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –µ–≥–æ):"
echo "=========================================="
cat "$KEY_PATH.pub"
echo ""
echo "=========================================="
echo ""
echo "üìå –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo ""
echo "1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á –≤—ã—à–µ"
echo "2. –û—Ç–∫—Ä–æ–π—Ç–µ Yandex Cloud Console: https://console.cloud.yandex.ru"
echo "3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ: Compute Cloud ‚Üí –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã"
echo "4. –í—ã–±–µ—Ä–∏—Ç–µ –í–ú: compute-vm-2-4-20-ssd-1769470006848"
echo "5. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É 'SSH-–∫–ª—é—á–∏'"
echo "6. –ù–∞–∂–º–∏—Ç–µ '–î–æ–±–∞–≤–∏—Ç—å SSH-–∫–ª—é—á'"
echo "7. –í—Å—Ç–∞–≤—å—Ç–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª—é—á"
echo "8. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ"
echo ""
echo "–ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–ª—é—á–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å:"
echo "  ssh -i $KEY_PATH $VM_USER@$VM_IP"
echo ""
echo "–ò–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ SSH config –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞:"
echo "  echo 'Host yandex-olga' >> ~/.ssh/config"
echo "  echo '    HostName $VM_IP' >> ~/.ssh/config"
echo "  echo '    User $VM_USER' >> ~/.ssh/config"
echo "  echo '    IdentityFile $KEY_PATH' >> ~/.ssh/config"
echo ""
echo "–¢–æ–≥–¥–∞ –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è –ø—Ä–æ—Å—Ç–æ:"
echo "  ssh yandex-olga"
echo ""
